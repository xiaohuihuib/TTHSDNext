name: TTHSD Next â€” è·¨å¹³å°æž„å»ºä¸Žæµ‹è¯•

on:
  push:
    branches: [main, master, dev]
    tags: ['v*']
  pull_request:
    branches: [main, master]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #  æ¡Œé¢å¹³å°æž„å»º (Windows / Linux / macOS Ã— AMD64 / ARM64)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-desktop:
    strategy:
      fail-fast: false
      matrix:
        include:
          # â”€â”€ Windows â”€â”€
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: tthsd.dll
            lib_name: tthsd.dll
          - os: windows-latest
            target: aarch64-pc-windows-msvc
            artifact_name: tthsd_arm64.dll
            lib_name: tthsd.dll

          # â”€â”€ Linux â”€â”€
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: tthsd.so
            lib_name: libtthsd.so
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            artifact_name: tthsd_arm64.so
            lib_name: libtthsd.so
            cross: true

          # â”€â”€ macOS â”€â”€
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: tthsd.dylib
            lib_name: libtthsd.dylib
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: tthsd_arm64.dylib
            lib_name: libtthsd.dylib

    runs-on: ${{ matrix.os }}
    name: ${{ matrix.artifact_name }} (${{ matrix.target }})

    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ¦€ å®‰è£… Rust å·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: ðŸ“¦ ç¼“å­˜ Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.target }}-

      - name: ðŸ”§ å®‰è£… cross (ARM64 Linux äº¤å‰ç¼–è¯‘)
        if: matrix.cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: ðŸ—ï¸ ç¼–è¯‘ (åŽŸç”Ÿ)
        if: "!matrix.cross"
        run: cargo build --release --target ${{ matrix.target }}

      - name: ðŸ—ï¸ ç¼–è¯‘ (äº¤å‰ç¼–è¯‘)
        if: matrix.cross
        run: cross build --release --target ${{ matrix.target }}

      - name: ðŸ“‹ é‡å‘½åäº§ç‰©
        shell: bash
        run: |
          SRC="target/${{ matrix.target }}/release/${{ matrix.lib_name }}"
          DST="${{ matrix.artifact_name }}"
          cp "$SRC" "$DST"
          echo "äº§ç‰©: $DST ($(du -h "$DST" | cut -f1))"

      - name: ðŸ“¤ ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.artifact_name }}
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #  Android æž„å»º (arm64-v8a / armeabi-v7a / x86_64)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-android:
    runs-on: ubuntu-latest
    name: tthsd_android.so (Android)
    strategy:
      fail-fast: false
      matrix:
        include:
          - abi: arm64-v8a
            target: aarch64-linux-android
            suffix: arm64
          - abi: armeabi-v7a
            target: armv7-linux-androideabi
            suffix: armv7
          - abi: x86_64
            target: x86_64-linux-android
            suffix: x86_64

    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ¦€ å®‰è£… Rust å·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: ðŸ“¦ ç¼“å­˜ Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: android-cargo-${{ matrix.target }}-${{ hashFiles('Cargo.lock') }}

      - name: ðŸ“± å®‰è£… cargo-ndk
        run: cargo install cargo-ndk

      - name: ðŸ—ï¸ ç¼–è¯‘ Android åº“
        run: |
          cargo ndk \
            --target ${{ matrix.abi }} \
            --platform 21 \
            build --release --features android

      - name: ðŸ“‹ é‡å‘½åäº§ç‰©
        run: |
          SRC="target/${{ matrix.target }}/release/libTTHSD.so"
          DST="tthsd_android_${{ matrix.suffix }}.so"
          cp "$SRC" "$DST"
          echo "äº§ç‰©: $DST ($(du -h "$DST" | cut -f1))"

      - name: ðŸ“¤ ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: tthsd_android_${{ matrix.suffix }}.so
          path: tthsd_android_${{ matrix.suffix }}.so
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #  é¸¿è’™ HarmonyOS æž„å»º (ARM64 / x86_64)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-harmony:
    runs-on: ubuntu-latest
    name: tthsd_harmony.so (HarmonyOS)
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-unknown-linux-ohos
            suffix: arm64
          - target: x86_64-unknown-linux-ohos
            suffix: x86_64

    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ¦€ å®‰è£… Rust nightly (OHOS æ”¯æŒ)
        uses: dtolnay/rust-toolchain@nightly
        with:
          targets: ${{ matrix.target }}

      - name: ðŸ“¦ ç¼“å­˜ Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: harmony-cargo-${{ matrix.target }}-${{ hashFiles('Cargo.lock') }}

      - name: ðŸ“¥ ä¸‹è½½ OpenHarmony SDK
        run: |
          # ä¸‹è½½ OHOS NDK (æ ¹æ®å®žé™…ç‰ˆæœ¬è°ƒæ•´ URL)
          OHOS_SDK_VERSION="4.1"
          OHOS_NDK_URL="https://repo.huaweicloud.com/openharmony/os/${OHOS_SDK_VERSION}/ohos-sdk-linux.tar.gz"
          mkdir -p $HOME/ohos-sdk
          echo "âš ï¸  é¸¿è’™ SDK ä¸‹è½½åœ°å€éœ€è¦æ ¹æ®å®žé™…ç‰ˆæœ¬è°ƒæ•´"
          echo "å¦‚æžœæ­¤æ­¥éª¤å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é…ç½® OHOS NDK è·¯å¾„"
          # curl -L "$OHOS_NDK_URL" | tar xz -C $HOME/ohos-sdk || true

      - name: ðŸ—ï¸ ç¼–è¯‘é¸¿è’™åº“
        env:
          OHOS_NDK_HOME: ${{ github.workspace }}/ohos-sdk/linux/native
        run: |
          # é…ç½®é¸¿è’™äº¤å‰ç¼–è¯‘é“¾æŽ¥å™¨
          mkdir -p .cargo
          cat > .cargo/config.toml << 'EOF'
          [target.aarch64-unknown-linux-ohos]
          linker = "aarch64-unknown-linux-ohos-clang"

          [target.x86_64-unknown-linux-ohos]
          linker = "x86_64-unknown-linux-ohos-clang"
          EOF

          echo "âš ï¸  é¸¿è’™ç¼–è¯‘éœ€è¦æ­£ç¡®é…ç½® OHOS NDKï¼Œæ­¤æ­¥éª¤å¯èƒ½éœ€è¦æ‰‹åŠ¨è°ƒæ•´"
          cargo +nightly build --release --target ${{ matrix.target }} || echo "é¸¿è’™ç¼–è¯‘éœ€è¦é¢å¤–é…ç½® OHOS NDK"

      - name: ðŸ“‹ é‡å‘½åäº§ç‰©
        run: |
          SRC="target/${{ matrix.target }}/release/libTTHSD.so"
          DST="tthsd_harmony_${{ matrix.suffix }}.so"
          if [ -f "$SRC" ]; then
            cp "$SRC" "$DST"
            echo "äº§ç‰©: $DST ($(du -h "$DST" | cut -f1))"
          else
            echo "âš ï¸  é¸¿è’™äº§ç‰©æœªç”Ÿæˆï¼Œéœ€è¦æ‰‹åŠ¨é…ç½® OHOS NDK"
          fi

      - name: ðŸ“¤ ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: tthsd_harmony_${{ matrix.suffix }}.so
          path: tthsd_harmony_${{ matrix.suffix }}.so
          retention-days: 30
          if-no-files-found: warn

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #  æµ‹è¯• (Linux + macOS + Windows åŽŸç”Ÿ)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test:
    needs: build-desktop
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            artifact: tthsd.so
            lib_env: LD_LIBRARY_PATH
          - os: macos-latest
            artifact: tthsd_arm64.dylib
            lib_env: DYLD_LIBRARY_PATH
          - os: windows-latest
            artifact: tthsd.dll
            lib_env: PATH
    runs-on: ${{ matrix.os }}
    name: æµ‹è¯• (${{ matrix.os }})

    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ“¥ ä¸‹è½½æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: .

      - name: ðŸ å®‰è£… Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: ðŸ§ª è¿è¡ŒåŸºç¡€åŠ è½½æµ‹è¯•
        shell: bash
        run: |
          echo "éªŒè¯åŠ¨æ€åº“å¯è¢«åŠ è½½..."
          python3 -c "
          import ctypes, sys, os
          lib_name = '${{ matrix.artifact }}'
          try:
              lib = ctypes.CDLL('./' + lib_name)
              print(f'[SUCCESS] Load {lib_name}')
              sys.exit(0)
          except Exception as e:
              print(f'[FAILED] error: {e}')
              sys.exit(1)
          "

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  #  å‘å¸ƒ Release (ä»…åœ¨ tag æŽ¨é€æ—¶è§¦å‘)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-desktop, build-android, test]
    runs-on: ubuntu-latest
    name: ðŸ“¦ å‘å¸ƒ Release
    permissions:
      contents: write

    steps:
      - name: ðŸ“¥ ä¸‹è½½æ‰€æœ‰äº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ðŸ“¦ æ‰“åŒ…ä¸º 7z
        run: |
          sudo apt-get install -y p7zip-full
          mkdir -p release_pkg

          # æ¡Œé¢å¹³å°
          cp artifacts/tthsd.so/tthsd.so release_pkg/ 2>/dev/null || true
          cp artifacts/tthsd_arm64.so/tthsd_arm64.so release_pkg/ 2>/dev/null || true
          cp artifacts/tthsd.dll/tthsd.dll release_pkg/ 2>/dev/null || true
          cp artifacts/tthsd_arm64.dll/tthsd_arm64.dll release_pkg/ 2>/dev/null || true
          cp artifacts/tthsd.dylib/tthsd.dylib release_pkg/ 2>/dev/null || true
          cp artifacts/tthsd_arm64.dylib/tthsd_arm64.dylib release_pkg/ 2>/dev/null || true

          # Android
          mkdir -p release_pkg/android
          cp artifacts/tthsd_android_arm64.so/tthsd_android_arm64.so release_pkg/android/ 2>/dev/null || true
          cp artifacts/tthsd_android_armv7.so/tthsd_android_armv7.so release_pkg/android/ 2>/dev/null || true
          cp artifacts/tthsd_android_x86_64.so/tthsd_android_x86_64.so release_pkg/android/ 2>/dev/null || true

          # é¸¿è’™
          mkdir -p release_pkg/harmony
          cp artifacts/tthsd_harmony_arm64.so/tthsd_harmony_arm64.so release_pkg/harmony/ 2>/dev/null || true
          cp artifacts/tthsd_harmony_x86_64.so/tthsd_harmony_x86_64.so release_pkg/harmony/ 2>/dev/null || true

          ls -lhR release_pkg/

          cd release_pkg
          7z a -t7z -m0=lzma2 -mx=9 ../TTHSD-${{ github.ref_name }}.7z *

      - name: ðŸš€ åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: TTHSD-${{ github.ref_name }}.7z
          generate_release_notes: true
